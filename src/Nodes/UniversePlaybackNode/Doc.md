# UniversePlaybackNode 帮助文档

## 概述

UniversePlaybackNode 是一个专业的视频播放节点，用于播放 HAP 编码的视频文件并将视频像素数据转换为 DMX 数据输出。该节点支持标准 Artnet 协议的 Universe、Subnet、Net 寻址，提供完整的播放控制功能，并支持循环播放和远程控制。

**主要特性**：
- 使用 FFmpeg 7.1 进行视频解码
- 支持 FFV1 编码视频文件播放
- 自动将视频像素转换为 DMX 数据
- 支持标准 Artnet 协议寻址（Universe、Subnet、Net）
- 提供完整的播放控制（播放、停止、循环）
- 支持输入端口远程控制与 OSC 控制
- 实时视频信息与当前播放时间显示（QTimeEdit，hh:mm:ss.zzz）
- 数据清空功能

## 功能说明

### 视频播放机制
- 固定 25fps 播放，确保稳定的 DMX 输出
- 像素映射：按“1 行 = 1 个 Universe，512 字节”进行提取与映射
- 尺寸要求：
  - FFV1：视频宽度为 128 像素（每像素 4 通道；128×4=512 字节）
  - 灰度：视频宽度为 512 像素（每像素 1 通道；512×1=512 字节）
  - 视频高度决定 Universe 数量（每行生成一个 Universe）
- 自动 Universe 计算：根据视频高度自动调整输出 Universe 数量

### 循环播放功能
- 循环复选框：界面提供循环播放开关控制
- 无缝循环：视频播放结束时自动回到开头继续播放
- 状态保存：循环状态可保存到项目文件中
- 远程控制：支持通过输入端口和 OSC 控制循环状态

### 播放控制
- 播放按钮：开始视频播放
- 停止按钮：停止视频播放并重置到开头
- 循环播放：启用循环模式后自动重复播放
- 文件选择：支持选择 HAP 编码的视频文件
- 清空数据：清空当前 DMX 输出数据

### Artnet 协议支持
- Universe 寻址：支持 Universe (0-15)、Subnet (0-15)、Net (0-127)
- 完整地址：自动计算完整 Universe 地址 = (Net << 8) | (Subnet << 4) | Universe
- 多 Universe 输出：根据视频高度自动输出多个 Universe
- 512 通道：每个 Universe 固定输出 512 个 DMX 通道数据

## 端口配置

### 输入端口
- 播放 (端口0)：接收播放触发信号
- 循环播放 (端口1)：接收循环播放触发信号
- 停止 (端口2)：接收停止播放信号
- 清除数据 (端口3)：接收清空数据信号

### 输出端口（动态）
- UNIVERSE0-N：根据视频高度动态生成的 Universe 输出端口
  - 每个端口输出完整的 Artnet Universe 数据包
  - 包含协议头信息、Universe 寻址信息、512 通道 DMX 数据
  - 包含统计信息和时间戳

## 界面说明

### Universe 配置
- Universe：Universe 编号设置 (0-15)
- Subnet：Subnet 编号设置 (0-15)
- Net：Net 编号设置 (0-127)

### 视频文件控制
- 选择文件：选择 HAP 编码的视频文件
- 文件名显示：显示当前选择的文件名
- 视频信息：显示视频尺寸、帧率、时长等信息

### 播放控制
- 播放按钮：开始播放视频
- 停止按钮：停止播放并重置到开头
- 循环播放复选框：启用/禁用循环播放模式
- 清空数据按钮：清空当前 DMX 输出数据

### 状态显示
- 播放状态：显示当前播放状态（播放中/已停止）
- 视频信息：实时显示视频参数
- 当前时间：QTimeEdit 只读显示，格式 `hh:mm:ss.zzz`
- 错误信息：显示文件加载或播放错误

## 使用示例

### 示例1：基本视频播放
1. 点击“选择文件”按钮选择 HAP 编码视频
2. 设置 Universe、Subnet、Net 参数
3. 点击“播放”按钮开始播放
4. 视频像素数据自动转换为 DMX 输出

### 示例2：循环播放设置
1. 选择视频文件并设置 Universe 参数
2. 勾选“循环播放”复选框
3. 点击“播放”按钮
4. 视频将无限循环播放直到手动停止

### 示例3：远程控制播放
1. 连接其他节点到 UniversePlaybackNode 的输入端口
2. 通过输入端口0发送信号触发播放
3. 通过输入端口1发送信号启用循环播放
4. 通过输入端口2发送信号停止播放

### 示例4：与 ArtnetOut 节点配合
1. UniversePlayback → ArtnetOut → 网络广播
2. Playback 节点负责视频播放与 DMX 数据生成
3. Out 节点负责网络传输
4. 支持多 Universe 的网络分发；建议在宽视频或多行时评估网络带宽

## OSC 控制

### 支持的 OSC 地址
- `/play` - 开始播放（发送任意值触发）
- `/stop` - 停止播放（发送任意值触发）
- `/loop` - 切换循环模式（发送 1 启用，0 禁用）
- `/clear` - 清空数据（发送任意值触发）


### OSC 消息格式
- 整数值：Universe、Subnet、Net 设置
- 布尔值：循环模式控制
- 触发操作：发送任意数值到对应地址即可触发

## 技术细节

### 视频处理
- 使用 FFmpeg 7.1 进行视频解码，支持 HAP、HAP Alpha、HAP Q 编码
- 按行解码并映射到 DMX：1 行 = 1 个 Universe
- 通道映射：
  - RGBA：一行 128 像素 × 4 通道 = 512 字节
  - 灰度：一行 512 像素 × 1 通道 = 512 字节
- 固定 25fps 播放帧率
- 视频宽度必须为128像素
- 像素RGB值直接映射到DMX通道

### 循环播放实现
- 播放结束时使用 `av_seek_frame()` 重新定位到文件开头
- 清空解码器缓冲区确保无缝循环
- 循环状态通过 `isLooping` 变量控制
- 支持界面复选框和输入端口控制

### 数据保存
- 保存 Universe、Subnet、Net 设置
- 保存循环播放状态
- 保存视频文件路径
- 保存视频信息（尺寸、帧率、时长等）
- 保存当前播放时间用于界面显示（不参与持久化回放）

## 注意事项

1. 视频格式要求：
   - 建议使用 HAP 编码格式（RGBA），宽度 128 像素
   - 如使用灰度格式，宽度需为 512 像素
   - 视频高度决定输出 Universe 数量
2. 性能考虑：
   - 多 Universe 输出会增加网络负载与 CPU 开销
   - 建议根据实际需求选择合适的视频尺寸
   - 25fps 固定帧率确保稳定的 DMX 输出
3. 循环播放：
   - 循环播放会持续占用系统资源
   - 长时间循环播放建议监控系统性能
   - 可通过停止按钮或输入端口随时停止
4. 网络传输：
   - 多 Universe 输出会增加网络负载
   - 建议配合 ArtnetOut 节点进行网络分发
   - 注意网络带宽和延迟影响
5. 文件管理：
   - 项目保存时会记录视频文件路径
   - 移动项目文件时需确保视频文件路径正确
   - 支持相对路径和绝对路径