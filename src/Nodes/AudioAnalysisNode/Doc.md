# AudioAnalysisNode 帮助文档

## 概述
AudioAnalysisNode 是一个专业的音频分析节点，基于GIST音频分析库实现实时音频特征提取和分析。支持多种音频特征计算，包括时域特征、频域特征、人声检测、频谱分析等功能。

## 功能特性
- **实时音频分析**：基于GIST库的高性能音频特征提取
- **多维度特征**：支持时域、频域、倒谱域等多种音频特征
- **人声检测**：基于机器学习算法的人声/乐器分类
- **频谱分析**：10段频率能量分布分析
- **MFCC特征**：梅尔频率倒谱系数提取
- **起始检测**：音频起始点检测功能
- **实时输出**：低延迟的实时分析结果输出

## 输入端口
- **端口类型**：AudioData
- **端口数量**：1个
- **数据格式**：支持AudioTimestampRingQueue共享缓冲区
- **音频格式**：16位有符号整数音频数据
- **采样率**：支持多种采样率（推荐48kHz）
- **帧大小**：2048采样点/帧（可配置）

## 输出端口
- **端口类型**：AnalysisData
- **端口数量**：1个
- **数据格式**：JSON格式的分析结果
- **更新频率**：实时更新（基于音频帧率）
- **数据内容**：包含所有音频特征的键值对

## 分析特征

### 时域特征
- **RMS (均方根值)**：音频信号的有效值，反映音频的整体能量
- **Peak (峰值能量)**：音频信号的峰值，用于检测瞬态信号
- **ZCR (零交叉率)**：信号穿越零点的频率，用于区分人声和乐器

### 频域特征
- **SpectralCentroid (频谱重心)**：频谱的重心位置，反映音频的"亮度"
- **SpectralRolloff (频谱滚降点)**：包含85%能量的频率点
- **SpectralFlux (频谱通量)**：频谱变化的剧烈程度
- **SpectralCrest (频谱峰值因子)**：频谱的峰值与平均值比率
- **SpectralFlatness (频谱平坦度)**：频谱的平坦程度
- **SpectralKurtosis (频谱峰度)**：频谱分布的尖锐程度

### 倒谱特征
- **MFCC_0 到 MFCC_3**：前4个梅尔频率倒谱系数
- **MelFrequencySpectrum**：梅尔频率谱

### 起始检测
- **EnergyDifference**：能量差分起始检测
- **SpectralDifference**：频谱差分起始检测
- **SpectralDifferenceHWR**：半波整流频谱差分
- **ComplexSpectralDifference**：复数频谱差分
- **HighFrequencyContent**：高频内容检测

### 音高检测
- **Pitch**：基于Yin算法的音高估计（Hz）

### 频段能量分析
- **Band1EnergyRatio 到 Band10EnergyRatio**：10个频段的能量占比
  - Band1: 0-63Hz（超低频）
  - Band2: 63-200Hz（低频）
  - Band3: 200-630Hz（中低频）
  - Band4: 630-2000Hz（中频）
  - Band5: 2000-6300Hz（中高频）
  - Band6: 6300-12500Hz（高频）
  - Band7: 12500-16000Hz（超高频）
  - Band8: 16000-18000Hz（极高频1）
  - Band9: 18000-20000Hz（极高频2）
  - Band10: >20000Hz（剩余频段）
- **Band1EnergyDB 到 Band10EnergyDB**：各频段的绝对能量值（dB）
- **TotalEnergyDB**：总能量值（dB）

### 人声检测
- **VoiceProbability**：人声概率（0-1）
- **InstrumentProbability**：乐器概率（0-1）

## 技术实现

### 核心组件
- **AudioAnalysisWorker**：工作线程类，负责音频分析处理
- **AudioAnalysisDataModel**：数据模型类，管理节点逻辑
- **GIST库集成**：基于GIST-1.0.7音频分析库
- **Kiss FFT**：快速傅里叶变换实现

### 音频处理流程
1. **数据接收**：从输入端口接收AudioFrame数据
2. **格式转换**：将int16_t数据转换为float并归一化
3. **GIST分析**：调用GIST库进行特征提取
4. **频段分析**：计算10段频率能量分布
5. **人声检测**：基于多特征融合的分类算法
6. **结果输出**：将分析结果以JSON格式输出

### 人声检测算法
```cpp
// 基于多特征加权评分的人声检测
float voiceScore = 0.0f;

// 零交叉率评分 (权重: 0.25)
if (zcr > 0.12f) voiceScore += 0.25f;
else if (zcr > 0.08f) voiceScore += 0.15f;
else if (zcr < 0.05f) voiceScore -= 0.1f;

// 频谱质心评分 (权重: 0.3)
if (spectralCentroid < 1500.0f) voiceScore += 0.3f;
else if (spectralCentroid < 2000.0f) voiceScore += 0.15f;
else if (spectralCentroid > 3000.0f) voiceScore -= 0.2f;

// 转换为概率
float voiceProb = std::max(0.0f, std::min(1.0f, 0.5f + voiceScore));
```

### 频段能量分析
```cpp
// 10段对数频率划分
std::vector<float> freqBands = {
    20.0f, 63.0f, 200.0f, 630.0f, 2000.0f, 
    6300.0f, 12500.0f, 16000.0f, 18000.0f, 20000.0f
};

// 计算各频段能量并归一化
for (int i = 0; i < 10; ++i) {
    analysisValues["Band" + std::to_string(i + 1) + "EnergyRatio"] = 
        bandEnergies[i] / totalEnergy;
}
```

## 配置参数

### GIST参数
- **帧大小**：2048采样点（推荐）
- **采样率**：48kHz（推荐）
- **窗函数**：汉宁窗（Hanning Window）
- **FFT实现**：Kiss FFT

### 处理参数
- **处理间隔**：实时处理（基于音频帧率）
- **缓冲区大小**：自适应
- **线程优先级**：正常优先级

## 使用说明

### 基本操作
1. 将音频源连接到输入端口
2. 节点自动开始实时音频分析
3. 从输出端口获取JSON格式的分析结果
4. 可以连接到其他节点进行后续处理

### 输出数据格式
```json
{
    "Rms": 0.123,
    "Peak": 0.456,
    "Zcr": 0.089,
    "SpectralCentroid": 1234.5,
    "SpectralRolloff": 3456.7,
    "VoiceProbability": 0.75,
    "InstrumentProbability": 0.25,
    "Band1EnergyRatio": 0.12,
    "Band2EnergyRatio": 0.15,
    ...
}
```

### 应用场景
- **音频内容分析**：自动识别音频内容类型
- **音频质量评估**：评估音频信号质量
- **实时音频可视化**：为音频可视化提供数据
- **音频分类**：区分人声、乐器、噪音等
- **音频特效控制**：基于音频特征控制效果参数
- **音频监控**：实时监控音频信号状态

## 性能特性

### 优化特点
- **GIST库优化**：使用高度优化的GIST音频分析库
- **Kiss FFT**：快速FFT实现，性能优异
- **多线程处理**：工作线程与UI线程分离
- **内存优化**：高效的内存使用和缓存策略

### 性能指标
- **处理延迟**：< 10ms
- **CPU占用**：< 8%（典型负载）
- **内存使用**：< 15MB
- **支持采样率**：8kHz - 192kHz
- **分析精度**：32位浮点精度

## 故障排除

### 常见问题
- **无分析输出**：检查音频输入是否正常
- **分析结果异常**：确认音频格式和采样率设置
- **性能问题**：调整帧大小和处理间隔
- **人声检测不准确**：可能需要针对特定音频内容调整阈值

### 调试方法
- **启用调试输出**：查看qDebug()日志信息
- **监控输入信号**：确认音频输入正常
- **检查GIST初始化**：验证GIST库初始化状态
- **分析结果验证**：对比已知音频的分析结果

## 技术限制

### 系统要求
- **操作系统**：Windows 10及以上
- **CPU**：支持SSE2指令集
- **内存**：至少4GB RAM
- **音频格式**：16位整数音频数据

### 使用限制
- **最大采样率**：192kHz
- **最小帧大小**：512采样点
- **最大帧大小**：8192采样点
- **支持声道**：单声道分析

## 依赖库
- **GIST-1.0.7**：音频分析核心库
- **Kiss FFT 1.3.0**：快速傅里叶变换
- **Qt6**：界面和系统框架
- **Eigen3**：矩阵运算库

## 版本信息
- **当前版本**：1.0.0
- **GIST版本**：1.0.7
- **编译器**：MSVC 2022
- **更新日期**：2025年
- **作者**：NodeEditor开发团队